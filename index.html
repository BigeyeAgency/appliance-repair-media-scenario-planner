<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sears Home Services - Scenario Planner v5.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 0;
            min-height: 800px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 800px;
        }

        .results-area {
            padding: 30px;
            background: white;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .dma-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .dma-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .dma-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .dma-inputs input {
            margin-bottom: 8px;
            font-size: 13px;
            padding: 8px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .results-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .summary-card h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.2rem;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
            font-size: 0.9rem;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .export-btn {
            background: #28a745;
            margin-top: 20px;
        }

        .export-btn:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .capacity-warning {
            background: #fff3cd;
            color: #856404;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .coupon-indicator {
            background: #d4edda;
            color: #155724;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .assumptions-log {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sears Home Services</h1>
            <p>Media Planning Scenario Planner</p>
            <div class="version-badge">v5.0 • Enhanced with Proxy Data</div>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="input-group">
                    <label>Scenario Mix</label>
                    <select id="mixSelect">
                        <option value="Efficiency">Efficiency Focus</option>
                        <option value="Balanced_v2" selected>Balanced v2 (Enhanced)</option>
                        <option value="Awareness">Awareness Focus</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Sensitivity Analysis</label>
                    <select id="sensitivitySelect">
                        <option value="Low">Low (80%)</option>
                        <option value="Base" selected>Base (100%)</option>
                        <option value="High">High (120%)</option>
                    </select>
                </div>

                <div class="toggle-group">
                    <label>Coupon Offer (Price-Sensitive DMAs)</label>
                    <div class="toggle-switch active" id="couponToggle" onclick="toggleCoupon()"></div>
                </div>

                <div class="input-group">
                    <label>Completion Rate (%)</label>
                    <input type="number" id="completionRate" value="80" min="1" max="100">
                </div>

                <div class="input-group">
                    <label>Gross Margin (%)</label>
                    <input type="number" id="grossMargin" value="30" min="1" max="100">
                </div>

                <div class="input-group">
                    <label>Measurement Reserve (%)</label>
                    <input type="number" id="measurementPct" value="4" min="0" max="10">
                </div>

                <div id="dmaInputs">
                    <!-- DMA inputs will be populated here -->
                </div>

                <button class="btn" onclick="calculateScenarios()">Calculate Scenarios</button>
                <button class="btn export-btn" onclick="exportToCSV()">Export Results</button>
            </div>

            <div class="results-area">
                <div class="results-tabs">
                    <button class="tab-btn active" onclick="showTab('summary')">Summary</button>
                    <button class="tab-btn" onclick="showTab('detailed')">Detailed Results</button>
                    <button class="tab-btn" onclick="showTab('charts')">Charts</button>
                    <button class="tab-btn" onclick="showTab('assumptions')">Assumptions Log</button>
                </div>

                <div id="summary" class="tab-content active">
                    <div class="summary-cards" id="summaryCards">
                        <!-- Summary cards will be populated here -->
                    </div>
                    <div class="table-container">
                        <table id="summaryTable">
                            <thead>
                                <tr>
                                    <th>DMA</th>
                                    <th>Total Spend</th>
                                    <th>Leads</th>
                                    <th>Repairs</th>
                                    <th>Gross Profit</th>
                                    <th>ROI</th>
                                    <th>Capacity</th>
                                    <th>Coupon</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="detailed" class="tab-content">
                    <div class="table-container">
                        <table id="detailedTable">
                            <thead>
                                <tr>
                                    <th>DMA</th>
                                    <th>Channel</th>
                                    <th>Spend</th>
                                    <th>Leads</th>
                                    <th>Creates</th>
                                    <th>Completed</th>
                                    <th>Profit</th>
                                    <th>Eff. CPL</th>
                                </tr>
                            </thead>
                            <tbody id="detailedTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="charts" class="tab-content">
                    <div class="chart-container">
                        <h3>Spend by DMA</h3>
                        <canvas id="spendChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Channel ROI Performance</h3>
                        <canvas id="channelChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Booking Rate by DMA</h3>
                        <canvas id="bookingChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <div id="assumptions" class="tab-content">
                    <div class="assumptions-log" id="assumptionsLog">
                        <!-- Assumptions will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var currentResults = [];
        var spendChart = null;
        var channelChart = null;
        var bookingChart = null;
        var addCoupon = true;

        // Enhanced v5.0 data based on proxy analysis
        var dmaData = [
            {
                name: "Orlando", 
                spanishShare: 0.23, 
                spend: 100000, 
                bookingBase: 0.25, 
                avgTicket: 171, 
                cplUplift: 1.00, 
                techs: 45,
                priceSensitive: true
            },
            {
                name: "Miami/Ft. Lauderdale", 
                spanishShare: 0.68, 
                spend: 150000, 
                bookingBase: 0.25, 
                avgTicket: 187, 
                cplUplift: 1.10, 
                techs: 110,
                priceSensitive: false
            },
            {
                name: "Jacksonville", 
                spanishShare: 0.09, 
                spend: 80000, 
                bookingBase: 0.25, 
                avgTicket: 165, 
                cplUplift: 1.00, 
                techs: 35,
                priceSensitive: true
            },
            {
                name: "Atlanta", 
                spanishShare: 0.15, 
                spend: 180000, 
                bookingBase: 0.25, 
                avgTicket: 181, 
                cplUplift: 1.05, 
                techs: 120,
                priceSensitive: false
            }
        ];

        var channels = {
            "LSA": {type: "CPL", unitCost: 35},
            "Search": {type: "CPL", unitCost: 82},
            "Meta": {type: "CPM", unitCost: 7.5, ctr: 0.010, c2l: 0.06},
            "CTV": {type: "CPM", unitCost: 25},
            "pDOOH": {type: "CPM", unitCost: 7.2},
            "Static_OOH": {type: "CPM", unitCost: 7.0}
        };

        // Enhanced mixes based on proxy insights
        var mixes = {
            "Efficiency": {"LSA": 0.45, "Search": 0.30, "Meta": 0.15, "CTV": 0.05, "pDOOH": 0.03, "Static_OOH": 0.02},
            "Balanced_v2": {"LSA": 0.28, "Search": 0.25, "Meta": 0.25, "CTV": 0.15, "pDOOH": 0.05, "Static_OOH": 0.02},
            "Awareness": {"LSA": 0.20, "Search": 0.20, "Meta": 0.25, "CTV": 0.25, "pDOOH": 0.07, "Static_OOH": 0.03}
        };

        var sensitivity = {"Low": 0.8, "Base": 1.0, "High": 1.2};
        var callsPerTechPerDay = 6;

        // Helper functions
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            return Math.round(num).toLocaleString();
        }

        function formatCurrency(num) {
            if (typeof num !== 'number' || isNaN(num)) return '$0';
            return '$' + Math.round(num).toLocaleString();
        }

        function toggleCoupon() {
            addCoupon = !addCoupon;
            var toggle = document.getElementById('couponToggle');
            if (addCoupon) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            calculateScenarios();
        }

        // Initialize DMA inputs with enhanced v5.0 parameters
        function initializeDMAInputs() {
            var container = document.getElementById('dmaInputs');
            container.innerHTML = '';
            
            for (var i = 0; i < dmaData.length; i++) {
                var dma = dmaData[i];
                var section = document.createElement('div');
                section.className = 'dma-section';
                section.innerHTML = 
                    '<h3>' + dma.name + '</h3>' +
                    '<div class="dma-inputs">' +
                        '<input type="number" id="spend_' + i + '" value="' + dma.spend + '" placeholder="3-Mo Spend">' +
                        '<input type="number" id="spanish_' + i + '" value="' + Math.round(dma.spanishShare * 100) + '" min="0" max="100" placeholder="Spanish %">' +
                        '<input type="number" id="booking_' + i + '" value="' + Math.round(dma.bookingBase * 100) + '" min="1" max="100" placeholder="Booking Base %">' +
                        '<input type="number" id="ticket_' + i + '" value="' + dma.avgTicket + '" placeholder="Avg Ticket $">' +
                        '<input type="number" id="cpl_' + i + '" value="' + dma.cplUplift.toFixed(2) + '" min="0.5" max="2" step="0.05" placeholder="CPL Uplift">' +
                        '<input type="number" id="techs_' + i + '" value="' + dma.techs + '" placeholder="Technicians">' +
                    '</div>';
                container.appendChild(section);
            }
        }

        function getDMAInputs() {
            var results = [];
            for (var i = 0; i < dmaData.length; i++) {
                var dma = dmaData[i];
                results.push({
                    name: dma.name,
                    priceSensitive: dma.priceSensitive,
                    spend: parseInt(document.getElementById('spend_' + i).value) || dma.spend,
                    spanishShare: (parseInt(document.getElementById('spanish_' + i).value) || Math.round(dma.spanishShare * 100)) / 100,
                    bookingBase: (parseInt(document.getElementById('booking_' + i).value) || Math.round(dma.bookingBase * 100)) / 100,
                    avgTicket: parseInt(document.getElementById('ticket_' + i).value) || dma.avgTicket,
                    cplUplift: parseFloat(document.getElementById('cpl_' + i).value) || dma.cplUplift,
                    techs: parseInt(document.getElementById('techs_' + i).value) || dma.techs
                });
            }
            return results;
        }

        function getGlobals() {
            return {
                completionRate: (parseInt(document.getElementById('completionRate').value) || 80) / 100,
                grossMargin: (parseInt(document.getElementById('grossMargin').value) || 30) / 100,
                measurementPct: (parseInt(document.getElementById('measurementPct').value) || 4) / 100
            };
        }

        function deriveRows(dma, mixName, sensLabel, globals) {
            var rows = [];
            var sensMult = sensitivity[sensLabel];
            
            // Enhanced booking rate with trust factor and coupon
            var booking = dma.bookingBase;
            if (addCoupon && dma.priceSensitive) {
                booking += 0.03; // +3 ppt coupon bump for price-sensitive DMAs
            }
            
            // Measurement reserve
            var measSpend = dma.spend * globals.measurementPct;
            rows.push({
                sensitivity: sensLabel,
                mix: mixName,
                dma: dma.name,
                channel: "Measurement",
                spend: measSpend,
                leads: 0,
                creates: 0,
                completed: 0,
                profit: -measSpend,
                effectiveCPL: 0
            });

            var remainingSpend = dma.spend - measSpend;
            var mixChannels = mixes[mixName];

            for (var ch in mixChannels) {
                var share = mixChannels[ch];
                var channelSpend = remainingSpend * share;
                
                var langSplits = [];
                if (ch === "Meta" || ch === "CTV") {
                    langSplits = [
                        ["_EN", 1 - dma.spanishShare, channelSpend], 
                        ["_ES", dma.spanishShare, channelSpend]
                    ];
                } else {
                    langSplits = [["", 1, channelSpend]];
                }

                for (var j = 0; j < langSplits.length; j++) {
                    var suffix = langSplits[j][0];
                    var pct = langSplits[j][1];
                    var spend = langSplits[j][2];
                    
                    if (pct === 0) continue;
                    
                    spend *= pct;
                    var label = ch + suffix;
                    
                    var channel = channels[ch];
                    var unitCost = channel.unitCost;
                    
                    // Apply CPL uplift and sensitivity
                    if (channel.type === "CPL") {
                        unitCost = unitCost * dma.cplUplift * sensMult;
                    } else {
                        unitCost = unitCost * sensMult;
                    }
                    
                    var leads;
                    if (channel.type === "CPL") {
                        leads = spend / unitCost;
                    } else {
                        var imps = (spend / unitCost) * 1000;
                        if (ch === "CTV") {
                            leads = imps * 0.01 * sensMult;
                        } else if (ch === "pDOOH" || ch === "Static_OOH") {
                            leads = imps * 0.0003;
                        } else { // Meta
                            leads = imps * channel.ctr * channel.c2l * sensMult;
                        }
                    }

                    var creates = leads * booking;
                    var completed = creates * globals.completionRate;
                    var profit = completed * dma.avgTicket * sensMult * globals.grossMargin;
                    var effectiveCPL = leads > 0 ? spend / leads : 0;

                    rows.push({
                        sensitivity: sensLabel,
                        mix: mixName,
                        dma: dma.name,
                        channel: label,
                        spend: spend,
                        leads: leads,
                        creates: creates,
                        completed: completed,
                        profit: profit,
                        effectiveCPL: effectiveCPL,
                        booking: booking
                    });
                }
            }
            return rows;
        }

        function calculateScenarios() {
            try {
                var mixName = document.getElementById('mixSelect').value;
                var sensLabel = document.getElementById('sensitivitySelect').value;
                var dmaInputs = getDMAInputs();
                var globals = getGlobals();

                currentResults = [];

                for (var i = 0; i < dmaInputs.length; i++) {
                    var dma = dmaInputs[i];
                    var rows = deriveRows(dma, mixName, sensLabel, globals);
                    currentResults = currentResults.concat(rows);
                }

                // Add capacity analysis
                for (var i = 0; i < currentResults.length; i++) {
                    var row = currentResults[i];
                    var dma = null;
                    for (var j = 0; j < dmaInputs.length; j++) {
                        if (dmaInputs[j].name === row.dma) {
                            dma = dmaInputs[j];
                            break;
                        }
                    }
                    if (dma) {
                        row.jobsPerDay = row.completed / 90;
                        row.capacityIssue = row.jobsPerDay > (dma.techs * callsPerTechPerDay);
                    }
                }

                updateDisplays();
                updateAssumptionsLog();
            } catch (error) {
                console.error('Error in calculateScenarios:', error);
                alert('Error calculating scenarios. Please check your inputs.');
            }
        }

        function updateDisplays() {
            updateSummaryCards();
            updateSummaryTable();
            updateDetailedTable();
            updateCharts();
        }

        function updateSummaryCards() {
            var totalSpend = 0;
            var totalLeads = 0;
            var totalRepairs = 0;
            var totalProfit = 0;
            
            for (var i = 0; i < currentResults.length; i++) {
                totalSpend += currentResults[i].spend || 0;
                totalLeads += currentResults[i].leads || 0;
                totalRepairs += currentResults[i].completed || 0;
                totalProfit += currentResults[i].profit || 0;
            }

            var roi = totalSpend > 0 ? ((totalProfit / totalSpend) * 100) : 0;

            document.getElementById('summaryCards').innerHTML = 
                '<div class="summary-card">' +
                    '<h3>Total Spend</h3>' +
                    '<div class="value">' + formatCurrency(totalSpend) + '</div>' +
                '</div>' +
                '<div class="summary-card">' +
                    '<h3>Total Leads</h3>' +
                    '<div class="value">' + formatNumber(totalLeads) + '</div>' +
                '</div>' +
                '<div class="summary-card">' +
                    '<h3>Completed Repairs</h3>' +
                    '<div class="value">' + formatNumber(totalRepairs) + '</div>' +
                '</div>' +
                '<div class="summary-card">' +
                    '<h3>Gross Profit</h3>' +
                    '<div class="value">' + formatCurrency(totalProfit) + '</div>' +
                '</div>' +
                '<div class="summary-card">' +
                    '<h3>Portfolio ROI</h3>' +
                    '<div class="value">' + roi.toFixed(1) + '%</div>' +
                '</div>';
        }

        function updateSummaryTable() {
            var dmaNames = [];
            for (var i = 0; i < currentResults.length; i++) {
                var dmaName = currentResults[i].dma;
                if (dmaNames.indexOf(dmaName) === -1) {
                    dmaNames.push(dmaName);
                }
            }
            
            var html = '';
            for (var i = 0; i < dmaNames.length; i++) {
                var dmaName = dmaNames[i];
                var totalSpend = 0;
                var totalLeads = 0;
                var totalRepairs = 0;
                var totalProfit = 0;
                var hasCapacityIssue = false;
                var hasCoupon = false;
                var avgBooking = 0;
                var bookingCount = 0;
                
                for (var j = 0; j < currentResults.length; j++) {
                    var row = currentResults[j];
                    if (row.dma === dmaName) {
                        totalSpend += row.spend || 0;
                        totalLeads += row.leads || 0;
                        totalRepairs += row.completed || 0;
                        totalProfit += row.profit || 0;
                        if (row.capacityIssue) hasCapacityIssue = true;
                        if (row.booking && row.booking > 0.25) {
                            hasCoupon = true;
                            avgBooking += row.booking;
                            bookingCount++;
                        }
                    }
                }
                
                var roi = totalSpend > 0 ? (totalProfit / totalSpend) * 100 : 0;

                html += '<tr>' +
                    '<td><strong>' + dmaName + '</strong></td>' +
                    '<td>' + formatCurrency(totalSpend) + '</td>' +
                    '<td>' + formatNumber(totalLeads) + '</td>' +
                    '<td>' + formatNumber(totalRepairs) + '</td>' +
                    '<td>' + formatCurrency(totalProfit) + '</td>' +
                    '<td>' + roi.toFixed(1) + '%</td>' +
                    '<td>' + (hasCapacityIssue ? '<span class="capacity-warning">⚠ Capacity Issue</span>' : '✓ OK') + '</td>' +
                    '<td>' + (hasCoupon ? '<span class="coupon-indicator">✓ Active</span>' : '—') + '</td>' +
                '</tr>';
            }
            
            document.getElementById('summaryTableBody').innerHTML = html;
        }

        function updateDetailedTable() {
            var html = '';
            
            for (var i = 0; i < currentResults.length; i++) {
                var row = currentResults[i];
                if (row.channel === 'Measurement') continue;
                
                html += '<tr>' +
                    '<td>' + row.dma + '</td>' +
                    '<td>' + row.channel + '</td>' +
                    '<td>' + formatCurrency(row.spend || 0) + '</td>' +
                    '<td>' + formatNumber(row.leads || 0) + '</td>' +
                    '<td>' + formatNumber(row.creates || 0) + '</td>' +
                    '<td>' + formatNumber(row.completed || 0) + '</td>' +
                    '<td>' + formatCurrency(row.profit || 0) + '</td>' +
                    '<td>' + formatCurrency(row.effectiveCPL || 0) + '</td>' +
                '</tr>';
            }
            
            document.getElementById('detailedTableBody').innerHTML = html;
        }

        function updateCharts() {
            updateSpendChart();
            updateChannelChart();
            updateBookingChart();
        }

        function updateSpendChart() {
            var ctx = document.getElementById('spendChart').getContext('2d');
            
            var dmaNames = [];
            for (var i = 0; i < currentResults.length; i++) {
                var dmaName = currentResults[i].dma;
                if (dmaNames.indexOf(dmaName) === -1) {
                    dmaNames.push(dmaName);
                }
            }
            
            var spendData = [];
            for (var i = 0; i < dmaNames.length; i++) {
                var dmaName = dmaNames[i];
                var totalSpend = 0;
                for (var j = 0; j < currentResults.length; j++) {
                    if (currentResults[j].dma === dmaName) {
                        totalSpend += currentResults[j].spend || 0;
                    }
                }
                spendData.push(totalSpend);
            }

            if (spendChart) {
                spendChart.destroy();
            }

            spendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dmaNames,
                    datasets: [{
                        label: 'Total Spend ($)',
                        data: spendData,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c'],
                        borderColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChannelChart() {
            var ctx = document.getElementById('channelChart').getContext('2d');
            var channelData = {};
            
            for (var i = 0; i < currentResults.length; i++) {
                var row = currentResults[i];
                if (row.channel === 'Measurement') continue;
                
                var baseChannel = row.channel.split('_')[0];
                if (!channelData[baseChannel]) {
                    channelData[baseChannel] = {spend: 0, profit: 0};
                }
                channelData[baseChannel].spend += row.spend || 0;
                channelData[baseChannel].profit += row.profit || 0;
            }

            var labels = Object.keys(channelData);
            var roiData = [];
            for (var i = 0; i < labels.length; i++) {
                var channel = labels[i];
                var roi = channelData[channel].spend > 0 ? 
                    (channelData[channel].profit / channelData[channel].spend) * 100 : 0;
                roiData.push(roi);
            }

            if (channelChart) {
                channelChart.destroy();
            }

            channelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ROI (%)',
                        data: roiData,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBookingChart() {
            var ctx = document.getElementById('bookingChart').getContext('2d');
            
            var dmaNames = [];
            var bookingRates = [];
            
            for (var i = 0; i < dmaData.length; i++) {
                var dma = dmaData[i];
                var booking = dma.bookingBase;
                if (addCoupon && dma.priceSensitive) {
                    booking += 0.03;
                }
                dmaNames.push(dma.name);
                bookingRates.push(booking * 100);
            }

            if (bookingChart) {
                bookingChart.destroy();
            }

            bookingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dmaNames,
                    datasets: [{
                        data: bookingRates,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAssumptionsLog() {
            var timestamp = new Date().toISOString();
            var mixName = document.getElementById('mixSelect').value;
            var sensLabel = document.getElementById('sensitivitySelect').value;
            var globals = getGlobals();
            var dmaInputs = getDMAInputs();
            
            var logHTML = '<h3>Assumptions Log - ' + timestamp.split('T')[0] + '</h3><br>';
            
            logHTML += '<strong>Global Settings:</strong><br>';
            logHTML += 'Mix: ' + mixName + '<br>';
            logHTML += 'Sensitivity: ' + sensLabel + '<br>';
            logHTML += 'Coupon Active: ' + (addCoupon ? 'Yes' : 'No') + '<br>';
            logHTML += 'Completion Rate: ' + (globals.completionRate * 100).toFixed(0) + '%<br>';
            logHTML += 'Gross Margin: ' + (globals.grossMargin * 100).toFixed(0) + '%<br>';
            logHTML += 'Measurement Reserve: ' + (globals.measurementPct * 100).toFixed(0) + '%<br><br>';
            
            logHTML += '<strong>DMA Parameters:</strong><br>';
            for (var i = 0; i < dmaInputs.length; i++) {
                var dma = dmaInputs[i];
                logHTML += dma.name + ':<br>';
                logHTML += '  Spanish Share: ' + (dma.spanishShare * 100).toFixed(0) + '%<br>';
                logHTML += '  Booking Base: ' + (dma.bookingBase * 100).toFixed(0) + '%<br>';
                logHTML += '  Avg Ticket:  + dma.avgTicket + '<br>';
                logHTML += '  CPL Uplift: ' + dma.cplUplift.toFixed(2) + 'x<br>';
                logHTML += '  Technicians: ' + dma.techs + '<br>';
                logHTML += '  Price Sensitive: ' + (dma.priceSensitive ? 'Yes' : 'No') + '<br><br>';
            }
            
            logHTML += '<strong>Media Mix (' + mixName + '):</strong><br>';
            var mix = mixes[mixName];
            for (var channel in mix) {
                logHTML += channel + ': ' + (mix[channel] * 100).toFixed(0) + '%<br>';
            }
            
            document.getElementById('assumptionsLog').innerHTML = logHTML;
        }

        function showTab(tabName) {
            var tabButtons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            var tabContents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Find and activate the correct tab button
            var buttons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].getAttribute('onclick').indexOf(tabName) > -1) {
                    buttons[i].classList.add('active');
                    break;
                }
            }
            
            // Show the selected tab content
            document.getElementById(tabName).classList.add('active');
        }

        function exportToCSV() {
            if (currentResults.length === 0) {
                alert('Please calculate scenarios first');
                return;
            }

            var headers = ['Sensitivity', 'Mix', 'DMA', 'Channel', 'Spend', 'Leads', 'Creates', 'Completed', 'Gross_Profit', 'Effective_CPL', 'Booking_Rate'];
            var csvContent = headers.join(',') + '\n';
            
            for (var i = 0; i < currentResults.length; i++) {
                var row = currentResults[i];
                csvContent += [
                    row.sensitivity,
                    row.mix,
                    row.dma,
                    row.channel,
                    (row.spend || 0).toFixed(2),
                    (row.leads || 0).toFixed(2),
                    (row.creates || 0).toFixed(2),
                    (row.completed || 0).toFixed(2),
                    (row.profit || 0).toFixed(2),
                    (row.effectiveCPL || 0).toFixed(2),
                    (row.booking || 0).toFixed(3)
                ].join(',') + '\n';
            }

            var blob = new Blob([csvContent], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'sears_scenario_planner_v5_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeDMAInputs();
            calculateScenarios(); // Run initial calculation
        });
    </script>
</body>
</html>
